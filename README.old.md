# Rack Manage Agent
 
The Rack Manage Agent (`rmagent`) is a lightweight agent that runs on an on-premises server and communicates with the Rack Manage Cloud Service. The agent is responsible for monitoring server uptime by pinging other devices on the network and sending the results to the cloud service.

The agent is written in Node.js and is compiled to a binary using [esbuild](https://esbuild.github.io/) and [pkg](https://www.npmjs.com/package/pkg). The agent is designed to be lightweight and run on a variety of operating systems.

Currently, the build system is configured to use Node.js 18.5.0 and produces binaries for Linux, MacOS, and Windows in both the x64 and ARM64 architectures.

## Requirements

Rack Manage Agent has limited dependencies and should run on most systems. If there is not a compiled binary for your system, you can build the agent from source.

Basic functionality such as pinging devices and installing the agent to launch on login work without any dependencies, however, some features like launching on startup and IPMI may require additional dependencies.

### Linux
- `libsecret` required for IPMI functionality
  - Debian/Ubuntu: `sudo apt-get install libsecret-1-dev`
  - Red Hat-based: `sudo yum install libsecret-devel`
  - Arch: `sudo pacman -S libsecret`
  - Alpine: `apk add libsecret-dev`
- `ipmitool` required for IPMI functionality
  - Debian/Ubuntu: `sudo apt-get install ipmitool`
  - Red Hat-based: `sudo yum install OpenIPMI ipmitool`
  - Arch: `sudo pacman -S ipmitool`
  - Alpine: `apk add ipmitool`

### MacOS
- `ipmitool` required for IPMI functionality
  - `brew install ipmitool`

### Windows
- .NET Framework 4 or later required for installing agent as a service
  - [Download .NET Framework](https://dotnet.microsoft.com/en-us/download/dotnet-framework)
- `ipmitool` required for IPMI functionality
  - [Download ipmitool](https://www.dell.com/support/home/en-us/drivers/driversdetails?driverid=m63f3)

## Installation

To install the Rack Manage Agent, download the appropriate binary for your system from [your Rack Manage account](https://rackmanage.io/app/settings?tab=5), or build the agent by running `npm run build`.

## Security

The Rack Manage Agent prioritizes security and privacy, ensuring that your sensitive information is safeguarded at all times:

### Data Protection
The agent solely transmits the outcomes of diagnostic checks, such as pings, to the Rack Manage Cloud Service. No sensitive data or credentials are ever sent.

### Secure Credential Storage
IPMI credentials are securely stored in the system's keychain, accessible only by the current user with the proper authentication. This ensures that your credentials are never exposed to external services.

### Communication Security
The agent operates quietly in the background, maintaining communication strictly with the Rack Manage Cloud Service over secure HTTPS connections. It connects exclusively to trusted endpoints (`auth.rackmanage.io` & `rmagent.firebaseio.com`), ensuring that your data is always transmitted securely.

### Authentication
Authentication with the Rack Manage Cloud Service is performed using a unique API key generated by the service which expires shortly after generation. This key facilitates the initial login process and is not stored on your device, preserving your system's security.

### User Control
Agents can be disabled or completely removed from the Rack Manage Cloud Service at any time. Disabling or deleting an agent immediately terminates its ability to send data, safeguarding your privacy.

### Open Source
The Rack Manage Agent is open source, allowing you to inspect, review, and understand exactly what you're installing.

## Development

### Development Requirements
- Node.js 18

To get started with development, clone the repository and run the following commands:

```bash
npm install
```

To build the agent for your current platform, first ensure that you have the correct version of Node.js installed. Then run the following command:

```bash
npm run build
```

This will create a binary in the `build` directory that you can run on your local machine.

To build for all platforms, run the following command:

```bash
npm run build:all
```

This will create binaries for Linux, MacOS, and Windows in both the x64 and ARM64 architectures.

Note that all dependencies should be marked as `devDependencies` in the `package.json` file unless they include native modules or are required at runtime, such as `sqlite3` and `keytar`. Any dependencies not marked for dev will be bundled by `pkg` which does not support ES6 modules. By marking dependencies as `devDependencies`, `esbuild` will bundle them into a single file which can then be packaged by `pkg`.

### Service Management
This agent is designed to run as a service in both user and system contexts (on login and on boot) for Linux, Windows, and MacOS, using systemd, launchd, and the Windows Service Manager, respectively. The service is configured to run the agent in the background and restart it if it crashes.

The `src/service` directory contains a subdirectory for each operating system that contains the necessary files to install the service. 

On Linux, the `rmagent-system.service.tpl` and `rmagent-user.service.tpl` files are used to create the systemd service files. 

On MacOS, the `io.rackmanage.rmagent.plist.tpl` file is used to create the launchd service file.

On Windows, the `rmservice.xml` file is used to configure the `rmservice.exe` service wrapper that runs the agent as a service. The Windows service is built on top of the [winsw](https://github.com/winsw/winsw) service wrapper for system wide services and requires .NET Framework 4.0 or later.

### Testing IPMI

To test IPMI without connecting to a real device, you can use the [`ipmi-simulator`](https://github.com/vapor-ware/ipmi-simulator) docker image.

To run the simulator, use the following command:

```bash
docker run -d -p 623:623/udp vaporio/ipmi-simulator
```

This will start the simulator on port 623. You can then test the agent's IPMI functionality by adding an IPMI device in the agent like so:

```bash
rmagent ipmi -s <server-address> -a localhost -u ADMIN -p ADMIN
```

### Future Work

The Rack Manage Agent is under active development, and we are continuously working to improve it. Some features we are considering for future releases include:
* Move from `commander` to `oclif` for a more robust CLI
  * Add IPMI as an optional plugin
  * Support automatic updates
* Sign binaries for Windows and MacOS